<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Traffic Prediction - Indore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&family=Quicksand&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      background-color: #0a0a0a;
      color: #fff;
      font-family: 'Quicksand', sans-serif;
    }
    #loginScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #121212;
      gap: 16px;
    }
    #loginScreen h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      color: #00c3ff;
      text-shadow: 0 0 10px #00ffe1;
    }
    .login-input-container {
      position: relative;
      width: 250px;
    }
    .login-input {
      width: 100%;
      padding: 10px 40px 10px 10px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      background: #1e1e1e;
      color: white;
    }
    .password-toggle {
      position: absolute;
      right: 5px;
      top: 0;
      bottom: 0;
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
    }
    .material-symbols-outlined {
      font-size: 22px;
      color: white;
    }
    .login-button, .google-btn {
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      width: 250px;
      font-weight: bold;
    }
    .login-button {
      background-color: #00c3ff;
      color: white;
      border: none;
    }
    .login-button:hover {
      background-color: #00ff88;
    }
    .google-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background-color: #ffffff;
      color: #000;
      border: none;
    }
    .google-btn:hover {
      background-color: #e0e0e0;
    }
    .google-btn img {
      width: 20px;
      height: 20px;
    }
    #googleAccounts {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: none;
      z-index: 100;
      margin-top: 5px;
    }
    .google-account {
      padding: 10px;
      color: black;
      text-align: left;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .google-account:hover {
      background-color: #f5f5f5;
    }
    #mainContent {
      display: none;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: linear-gradient(90deg, #00c3ff, #00ff88);
      padding: 1rem;
      text-align: center;
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
      font-weight: bold;
      text-transform: uppercase;
      color: white;
      text-shadow: 0 0 8px #00ffe1, 0 0 12px #00c3ff;
    }
    .form-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 0.8rem;
      background: #121212;
    }
    .input-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-size: 0.85rem;
      font-weight: bold;
      margin-bottom: 4px;
      color: #fff;
    }
    input {
      padding: 6px 10px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      background: #1e1e1e;
      color: white;
      width: 180px;
    }
    input:focus {
      outline: 2px solid #00c3ff;
    }
    .transport-section {
      background-color: #1a1a1a;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .transport-options {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }
    .transport-options button {
      background-color: #444;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .transport-options button:hover {
      background-color: #666;
    }
    .transport-options button.active {
      background-color: #00c3ff;
      color: #0a0a0a;
    }
    #routeBtn {
      background: linear-gradient(90deg, #00c3ff, #00ff88);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      width: 200px;
      margin: 0 auto;
    }
    #routeBtn:hover {
      opacity: 0.9;
    }
    #map {
      flex-grow: 1;
      width: 100%;
    }
    #trafficResult {
      text-align: center;
      padding: 0.5rem;
      background: #181818;
      font-size: 0.9rem;
      color: #00ffcc;
      display: none;
    }
    footer {
      text-align: center;
      padding: 0.4rem;
      background: #1c1c1c;
      font-size: 0.75rem;
      color: #aaa;
    }
    .permission-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      text-align: center;
      max-width: 300px;
      display: none;
    }
    .permission-dialog h3 {
      margin-bottom: 15px;
      color: #00c3ff;
    }
    .permission-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    .permission-btn {
      padding: 8px 15px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    .permission-allow {
      background-color: #00c3ff;
      color: white;
    }
    .permission-deny {
      background-color: #444;
      color: white;
    }
    @media screen and (max-width: 600px) {
      .form-container {
        flex-direction: column;
        align-items: stretch;
        padding: 1rem;
      }
      input, button {
        width: 100%;
      }
      .input-group {
        width: 100%;
      }
      .transport-options {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <h2>Login to Continue</h2>
  <div class="login-input-container">
    <input type="email" class="login-input" id="loginEmail" placeholder="Email address" />
  </div>
  <div class="login-input-container">
    <input type="password" class="login-input" id="loginPassword" placeholder="Password" />
    <button class="password-toggle" onclick="togglePassword()">
      <span class="material-symbols-outlined">visibility</span>
    </button>
  </div>
  <button class="login-button" onclick="fakeLogin()">Login</button>
  <div style="position: relative;">
    <button class="google-btn" onclick="showGoogleAccounts()">
      <img src="google.jpg" alt="Google Logo" />
      Continue with Google
    </button>
    <div id="googleAccounts">
      <div class="google-account" onclick="selectAccount('user1@gmail.com')">user1@gmail.com</div>
      <div class="google-account" onclick="selectAccount('user2@gmail.com')">user2@gmail.com</div>
      <div class="google-account" onclick="selectAccount('user3@gmail.com')">user3@gmail.com</div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainContent">
  <header>TRAFFIC FORECASTING - INDORE</header>
  <div class="form-container">
    <div class="input-group">
      <label for="source">Source</label>
      <input type="text" id="source" list="places-list" placeholder="e.g., Vijay Nagar" autocomplete="off" />
    </div>
    <div class="input-group">
      <label for="destination">Destination</label>
      <input type="text" id="destination" list="places-list" placeholder="e.g., Rajwada" autocomplete="off" />
    </div>
    <div class="input-group">
      <label for="date">Date</label>
      <input type="text" id="date" class="flatpickr" />
    </div>
    <div class="input-group">
      <label for="time">Time</label>
      <input type="text" id="time" class="flatpickr" />
    </div>
  </div>
  <datalist id="places-list">
    <option value="Vijay Nagar">
    <option value="Rajwada">
    <option value="Palasia">
    <option value="Bhawarkua">
    <option value="Nipania">
    <option value="Chhoti Gwaltoli">
    <option value="Bengali Square">
    <option value="Geeta Bhawan">
    <option value="LIG Square">
    <option value="MG Road">
    <option value="Khandwa Road">
    <option value="AB Road">
    <option value="Ring Road">
    <option value="MR 10">
    <option value="MR 9">
    <option value="MR 8">
    <option value="MR 7">
    <option value="MR 6">
    <option value="MR 5">
    <option value="MR 4">
    <option value="MR 3">
    <option value="MR 2">
    <option value="MR 1">
    <option value="Treasure Island Mall">
    <option value="C21 Mall">
    <option value="Phoenix Citadel Mall">
    <option value="Central Mall">
    <option value="Malhar Mega Mall">
    <option value="Prestige Mall">
    <option value="Sapna Sangeeta Mall">
    <option value="Rajendra Nagar Mall">
    <option value="MY Hospital">
    <option value="Choithram Hospital">
    <option value="Bombay Hospital">
    <option value="Apollo Hospital">
    <option value="Medanta Hospital">
    <option value="Sri Aurobindo Hospital">
    <option value="Kokilaben Hospital">
    <option value="Life Care Hospital">
    <option value="Shri Krishna Hospital">
    <option value="City Hospital">
    <option value="Khajrana Temple">
    <option value="Sarafa Bazaar">
    <option value="Rajwada Palace">
    <option value="Lalbagh Palace">
    <option value="Kanch Mandir">
    <option value="Gomatgiri">
    <option value="Patalpani">
    <option value="Tincha Falls">
    <option value="Ralamandal">
    <option value="Choral Dam">
    <option value="Indore Airport">
    <option value="Railway Station">
    <option value="Bus Stand">
    <option value="Devi Ahilya Bai Holkar Airport">
    <option value="Indore Junction">
    <option value="Rajendra Nagar Station">
    <option value="Lakshmibai Nagar Station">
    <option value="IIT Indore">
    <option value="IIM Indore">
    <option value="DAVV University">
    <option value="IPS Academy">
    <option value="SGSITS">
    <option value="Medicaps University">
    <option value="Acropolis Institute">
    <option value="Vikram University">
    <option value="Rajwada Market">
    <option value="Sarafa Market">
    <option value="Chappan Dukaan">
    <option value="56 Dukaan">
    <option value="Khatipura Market">
    <option value="Vijay Nagar Market">
    <option value="Palasia Market">
    <option value="Bhawarkua Market">
    <option value="Nehru Park">
    <option value="Kamla Nehru Park">
    <option value="Regional Park">
    <option value="Indore Zoo">
    <option value="Patalpani Waterfall">
    <option value="Tincha Waterfall">
    <option value="Collector Office">
    <option value="Municipal Corporation">
    <option value="Police Station">
    <option value="District Court">
    <option value="High Court">
    <option value="Passport Office">
    <option value="RTO Office">
    <option value="Gurudwara">
    <option value="Masjid">
    <option value="Church">
    <option value="Jain Temple">
    <option value="Hanuman Temple">
    <option value="Ganesh Temple">
    <option value="Shiv Temple">
    <option value="Durga Temple">
  </datalist>
  <div class="transport-section">
    <div class="transport-options">
      <button class="active">🚲 Bike</button>
      <button>🚗 Car</button>
      <button>🚶 Walk</button>
    </div>
    <button id="routeBtn">Show Best Route</button>
  </div>
  <div id="trafficResult"></div>
  <div id="map"></div>
  <footer>🌍 Made with ❤️ for Indore | Demo UI</footer>
</div>

<!-- PERMISSION DIALOG -->
<div class="permission-dialog" id="permissionDialog">
  <h3>Location Access Required</h3>
  <p>This app wants to access your location to provide accurate traffic information.</p>
  <div class="permission-buttons">
    <button class="permission-btn permission-deny" onclick="handlePermission(false)">Deny</button>
    <button class="permission-btn permission-allow" onclick="handlePermission(true)">Allow</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  let selectedTransport = 'bike';
  let map;
  let userMarker;

  // Local mapping of Indore locations to lat,lng
  const indoreLocations = {
    // Major Areas
    "Vijay Nagar": "22.7519,75.8937",
    "Rajwada": "22.7196,75.8577",
    "Palasia": "22.7193,75.8800",
    "Bhawarkua": "22.6986,75.8647",
    "Nipania": "22.7177,75.9121",
    "Chhoti Gwaltoli": "22.7205,75.8642",
    "Bengali Square": "22.7198,75.9042",
    "Geeta Bhawan": "22.7190,75.8730",
    "LIG Square": "22.7372,75.8896",
    "MG Road": "22.7192,75.8577",
    "Khandwa Road": "22.7177,75.9121",
    "AB Road": "22.7193,75.8800",
    "Ring Road": "22.6986,75.8647",
    "MR 10": "22.7205,75.8642",
    "MR 9": "22.7198,75.9042",
    "MR 8": "22.7190,75.8730",
    "MR 7": "22.7372,75.8896",
    "MR 6": "22.7192,75.8577",
    "MR 5": "22.7177,75.9121",
    "MR 4": "22.7193,75.8800",
    "MR 3": "22.6986,75.8647",
    "MR 2": "22.7205,75.8642",
    "MR 1": "22.7198,75.9042",
    
    // Malls and Shopping Centers
    "Treasure Island Mall": "22.7376,75.8892",
    "C21 Mall": "22.7376,75.8892",
    "Phoenix Citadel Mall": "22.7376,75.8892",
    "Central Mall": "22.7196,75.8577",
    "Malhar Mega Mall": "22.7196,75.8577",
    "Prestige Mall": "22.7196,75.8577",
    "Sapna Sangeeta Mall": "22.7196,75.8577",
    "Rajendra Nagar Mall": "22.7196,75.8577",
    
    // Hospitals
    "MY Hospital": "22.7196,75.8577",
    "Choithram Hospital": "22.7196,75.8577",
    "Bombay Hospital": "22.7196,75.8577",
    "Apollo Hospital": "22.7196,75.8577",
    "Medanta Hospital": "22.7196,75.8577",
    "Sri Aurobindo Hospital": "22.7196,75.8577",
    "Kokilaben Hospital": "22.7196,75.8577",
    "Life Care Hospital": "22.7196,75.8577",
    "Shri Krishna Hospital": "22.7196,75.8577",
    "City Hospital": "22.7196,75.8577",
    
    // Landmarks and Temples
    "Khajrana Temple": "22.7342,75.9180",
    "Sarafa Bazaar": "22.7197,75.8555",
    "Rajwada Palace": "22.7196,75.8577",
    "Lalbagh Palace": "22.7196,75.8577",
    "Kanch Mandir": "22.7196,75.8577",
    "Gomatgiri": "22.7196,75.8577",
    "Patalpani": "22.7196,75.8577",
    "Tincha Falls": "22.7196,75.8577",
    "Ralamandal": "22.7196,75.8577",
    "Choral Dam": "22.7196,75.8577",
    
    // Transport Hubs
    "Indore Airport": "22.7280,75.8011",
    "Railway Station": "22.7206,75.8648",
    "Bus Stand": "22.7196,75.8577",
    "Devi Ahilya Bai Holkar Airport": "22.7280,75.8011",
    "Indore Junction": "22.7206,75.8648",
    "Rajendra Nagar Station": "22.7196,75.8577",
    "Lakshmibai Nagar Station": "22.7196,75.8577",
    
    // Educational Institutions
    "IIT Indore": "22.7196,75.8577",
    "IIM Indore": "22.7196,75.8577",
    "DAVV University": "22.7196,75.8577",
    "IPS Academy": "22.7196,75.8577",
    "SGSITS": "22.7196,75.8577",
    "Medicaps University": "22.7196,75.8577",
    "Acropolis Institute": "22.7196,75.8577",
    "Vikram University": "22.7196,75.8577",
    
    // Markets and Commercial Areas
    "Rajwada Market": "22.7196,75.8577",
    "Sarafa Market": "22.7197,75.8555",
    "Chappan Dukaan": "22.7196,75.8577",
    "56 Dukaan": "22.7196,75.8577",
    "Khatipura Market": "22.7196,75.8577",
    "Vijay Nagar Market": "22.7519,75.8937",
    "Palasia Market": "22.7193,75.8800",
    "Bhawarkua Market": "22.6986,75.8647",
    
    // Parks and Recreation
    "Nehru Park": "22.7196,75.8577",
    "Kamla Nehru Park": "22.7196,75.8577",
    "Regional Park": "22.7196,75.8577",
    "Indore Zoo": "22.7196,75.8577",
    "Patalpani Waterfall": "22.7196,75.8577",
    "Tincha Waterfall": "22.7196,75.8577",
    
    // Government Offices
    "Collector Office": "22.7196,75.8577",
    "Municipal Corporation": "22.7196,75.8577",
    "Police Station": "22.7196,75.8577",
    "District Court": "22.7196,75.8577",
    "High Court": "22.7196,75.8577",
    "Passport Office": "22.7196,75.8577",
    "RTO Office": "22.7196,75.8577",
    
    // Religious Places
    "Gurudwara": "22.7196,75.8577",
    "Masjid": "22.7196,75.8577",
    "Church": "22.7196,75.8577",
    "Jain Temple": "22.7196,75.8577",
    "Hanuman Temple": "22.7196,75.8577",
    "Ganesh Temple": "22.7196,75.8577",
    "Shiv Temple": "22.7196,75.8577",
    "Durga Temple": "22.7196,75.8577"
  };

  function fakeLogin() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    if (!email || !password) {
      alert("Please enter both email and password.");
      return;
    }

    if (password !== "khushi") {
      alert("Incorrect password.");
      return;
    }

    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainContent").style.display = "flex";
    initMap();
    showPermissionDialog();
  }

  function togglePassword() {
    const input = document.getElementById("loginPassword");
    const icon = document.querySelector(".password-toggle .material-symbols-outlined");
    input.type = input.type === "password" ? "text" : "password";
    icon.textContent = icon.textContent === "visibility" ? "visibility_off" : "visibility";
  }

  function showGoogleAccounts() {
    const box = document.getElementById("googleAccounts");
    box.style.display = box.style.display === "block" ? "none" : "block";
  }

  function selectAccount(email) {
    document.getElementById("loginEmail").value = email;
    document.getElementById("googleAccounts").style.display = "none";
  }

  function initMap() {
    map = L.map('map').setView([22.7196, 75.8577], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  }

  function showPermissionDialog() {
    document.getElementById('permissionDialog').style.display = 'block';
  }

  function handlePermission(allowed) {
    document.getElementById('permissionDialog').style.display = 'none';
    if (allowed) {
      enableLocation();
    } else {
      alert("Location access is required for full functionality. You can enable it later in your browser settings.");
    }
  }

  function enableLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          map.setView([latitude, longitude], 14);
          if (userMarker) map.removeLayer(userMarker);
          userMarker = L.marker([latitude, longitude]).addTo(map)
            .bindPopup("You are here").openPopup();
        },
        error => {
          console.error(error);
        },
        { enableHighAccuracy: true }
      );
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  }

  document.querySelectorAll('.transport-options button').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.transport-options button').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      selectedTransport = this.textContent.includes('Bike') ? 'bike' : 
                         this.textContent.includes('Car') ? 'car' : 'walk';
    });
  });

  // Helper to convert '30-06-2025' and '5:00 PM' to ISO string
  function toISODateTime(date, time) {
    if (!date || !time) return new Date().toISOString();
    // Parse date: '30-06-2025'
    const [day, month, year] = date.split('-');
    // Parse time: '5:00 PM' or '17:00'
    let [h, minRest] = time.split(':');
    let minute = parseInt(minRest);
    let hour = parseInt(h);
    if (time.toLowerCase().includes('pm') && hour < 12) hour += 12;
    if (time.toLowerCase().includes('am') && hour === 12) hour = 0;
    // Remove AM/PM
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`;
  }

  // Helper: Geocode place name to lat,lng using local mapping or Nominatim
  async function geocodePlace(place) {
    // If already in lat,lng format, return as is
    if (/^-?\d+\.\d+,-?\d+\.\d+$/.test(place.trim())) return place.trim();
    
    // Check local mapping first
    if (indoreLocations[place.trim()]) {
      return indoreLocations[place.trim()];
    }
    
    // Fallback to Nominatim API
    const url = `https://nominatim.openstreetmap.org/search?city=Indore&state=Madhya%20Pradesh&country=India&q=${encodeURIComponent(place)}&format=json&limit=1`;
    const resp = await fetch(url, {headers: { 'Accept-Language': 'en' }});
    const data = await resp.json();
    if (data && data.length > 0) {
      return `${data[0].lat},${data[0].lon}`;
    } else {
      throw new Error('Location not found: ' + place);
    }
  }

  document.getElementById("routeBtn").addEventListener("click", async function () {
    let source = document.getElementById("source").value;
    let destination = document.getElementById("destination").value;
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;

    if (!source || !destination) {
      alert("Please enter both source and destination");
      return;
    }

    const trafficResult = document.getElementById("trafficResult");
    trafficResult.style.display = "block";
    trafficResult.innerHTML = "⏳ Predicting traffic...";

    try {
      // Geocode source and destination if needed
      source = await geocodePlace(source);
      destination = await geocodePlace(destination);
      const dateTimeStr = toISODateTime(date, time);
      const body = {
        source: source, // now always 'lat,lng'
        destination: destination, // now always 'lat,lng'
        date_time: dateTimeStr,
        travel_mode: selectedTransport
      };
      console.log("Sending to backend:", body);
      const response = await fetch("/api/routes/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await response.json();
      console.log("Backend response:", data);
      if (!response.ok) {
        trafficResult.innerHTML = `<div style='color:red;'>${data.error || 'Error fetching route'}</div>`;
        return;
      }
      // Show best route
      const best = data.find(r => r.recommended) || data[0];
      trafficResult.innerHTML = `
        <div><b>${best.route_name}</b></div>
        <div>Total Distance: ${best.total_distance_km} km</div>
        <div>Estimated Time: ${best.total_time_min} min</div>
        <div>Segments:</div>
        <ul>${best.segments.map(seg => `<li>${seg.congestion_level.toUpperCase()} | ${seg.length_m}m | ${seg.speed_kmh} km/h</li>`).join('')}</ul>
      `;
      // Optionally, draw route on map
      if (map && best.segments.length > 0) {
        console.log("Drawing route on map with", best.segments.length, "segments");
        
        // Remove previous route and markers
        if (window.routePolylineGroup) {
          window.routePolylineGroup.forEach(l => map.removeLayer(l));
        }
        window.routePolylineGroup = [];
        if (window.sourceMarker) map.removeLayer(window.sourceMarker);
        if (window.destMarker) map.removeLayer(window.destMarker);

        // Draw each segment with color
        for (let i = 0; i < best.segments.length; i++) {
          const seg = best.segments[i];
          const color = seg.congestion_level === 'red' ? 'red' : seg.congestion_level === 'yellow' ? 'yellow' : 'green';
          const latlngs = [
            [seg.latitude_start, seg.longitude_start],
            [seg.latitude_end, seg.longitude_end]
          ];
          console.log(`Drawing segment ${i}: ${color} from [${seg.latitude_start}, ${seg.longitude_start}] to [${seg.latitude_end}, ${seg.longitude_end}]`);
          const polyline = L.polyline(latlngs, {color, weight: 7, opacity: 0.8}).addTo(map);
          window.routePolylineGroup.push(polyline);
        }
        
        // Fit map to route
        const allLatLngs = best.segments.flatMap(seg => [
          [seg.latitude_start, seg.longitude_start],
          [seg.latitude_end, seg.longitude_end]
        ]);
        map.fitBounds(allLatLngs);
        
        // Add source and destination markers with red location emoji
        const src = best.segments[0];
        const dst = best.segments[best.segments.length-1];
        console.log("Adding source marker at:", src.latitude_start, src.longitude_start);
        console.log("Adding dest marker at:", dst.latitude_end, dst.longitude_end);
        
        window.sourceMarker = L.marker([src.latitude_start, src.longitude_start], {
          icon: L.divIcon({className: '', html: '📍', iconSize: [36,36], iconAnchor: [18,36]})
        }).addTo(map);
        window.destMarker = L.marker([dst.latitude_end, dst.longitude_end], {
          icon: L.divIcon({className: '', html: '📍', iconSize: [36,36], iconAnchor: [18,36]})
        }).addTo(map);
        
        console.log("Route drawing completed");
      } else {
        console.log("Map or segments not available. Map:", !!map, "Segments:", best.segments?.length);
      }
    } catch (err) {
      trafficResult.innerHTML = `<div style='color:red;'>Error: ${err.message}</div>`;
    }
  });

  flatpickr("#date", {
    dateFormat: "d-m-Y"
  });

  flatpickr("#time", {
    enableTime: true,
    noCalendar: true,
    dateFormat: "h:i K",
    time_24hr: false
  });

  document.addEventListener('click', function (e) {
    if (!e.target.closest('.google-btn') && !e.target.closest('#googleAccounts')) {
      document.getElementById('googleAccounts').style.display = 'none';
    }
  });
</script>
</body>
</html>
